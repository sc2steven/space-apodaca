<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPACE APODACA</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
  }

  #wrapper {
    position: relative;
    width: 600px;
  }

  #hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 4px;
    color: #fff;
    font-size: 0.5rem;
    letter-spacing: 0.05em;
  }

  #canvas {
    display: block;
    background: #000;
    border: 2px solid #333;
    image-rendering: pixelated;
  }

  /* Mobile controls */
  #mobile-controls {
    display: none;
    justify-content: space-between;
    align-items: center;
    padding: 12px 4px 0;
    gap: 12px;
  }

  .ctrl-btn {
    background: #111;
    border: 2px solid #444;
    color: #fff;
    font-family: 'Press Start 2P', monospace;
    font-size: 0.6rem;
    padding: 14px 22px;
    cursor: pointer;
    border-radius: 4px;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
    flex: 1;
    text-align: center;
  }

  .ctrl-btn:active { background: #333; border-color: #0f0; }
  #fire-btn { border-color: #f00; color: #f00; }
  #fire-btn:active { background: #300; }

  #overlay {
    position: absolute;
    top: 36px; left: 0;
    width: 100%;
    height: 600px;
    background: rgba(0,0,0,0.88);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 18px;
    z-index: 10;
  }

  #overlay h1 {
    color: #0f0;
    font-size: 1.1rem;
    text-align: center;
    line-height: 1.8;
    text-shadow: 0 0 16px #0f0;
    animation: glow 1.5s infinite alternate;
  }

  @keyframes glow {
    from { text-shadow: 0 0 8px #0f0; }
    to   { text-shadow: 0 0 24px #0f0, 0 0 40px #0f0; }
  }

  #overlay p {
    color: #aaa;
    font-size: 0.38rem;
    line-height: 2.2;
    text-align: center;
  }

  #overlay .score-table {
    color: #fff;
    font-size: 0.38rem;
    line-height: 2.4;
    text-align: left;
  }

  #overlay .score-table span { color: #0f0; }

  #start-btn {
    background: transparent;
    border: 2px solid #0f0;
    color: #0f0;
    font-family: 'Press Start 2P', monospace;
    font-size: 0.5rem;
    padding: 12px 24px;
    cursor: pointer;
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
  }

  #start-btn:hover { background: #0f0; color: #000; animation: none; }

  #hi-score-line { color: #ff0; font-size: 0.38rem; }
</style>
</head>
<body>

<div id="wrapper">
  <div id="hud">
    <span>SCORE: <span id="score-display">0</span></span>
    <span id="hi-score-line">HI: <span id="hi-display">0</span></span>
    <span>LIVES: <span id="lives-display">3</span></span>
  </div>

  <canvas id="canvas" width="600" height="600"></canvas>

  <div id="mobile-controls">
    <button class="ctrl-btn" id="left-btn">‚óÄ LEFT</button>
    <button class="ctrl-btn" id="fire-btn">FIRE</button>
    <button class="ctrl-btn" id="right-btn">RIGHT ‚ñ∂</button>
  </div>

  <div id="overlay">
    <h1>SPACE<br>APODACA</h1>
    <div class="score-table">
      <span>üëæ</span> ROW 1 = 30 PTS<br>
      <span>üëΩ</span> ROW 2 = 20 PTS<br>
      <span>üõ∏</span> ROW 3 = 10 PTS<br>
    </div>
    <p>‚Üê ‚Üí MOVE &nbsp;|&nbsp; SPACE FIRE<br>DESTROY ALL INVADERS!</p>
    <button id="start-btn">PRESS START</button>
  </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const W = canvas.width;
const H = canvas.height;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = 'menu'; // menu | playing | dead | win | gameover
let score = 0;
let hiScore = 0;
let lives = 3;
let level = 1;
let animId;
let lastTime = 0;

// Input
const keys = {};
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (e.code === 'Space') e.preventDefault();
});
document.addEventListener('keyup', e => keys[e.code] = false);

// Mobile buttons
const leftBtn  = document.getElementById('left-btn');
const rightBtn = document.getElementById('right-btn');
const fireBtn  = document.getElementById('fire-btn');

leftBtn.addEventListener('touchstart',  () => keys['ArrowLeft']  = true,  {passive:true});
leftBtn.addEventListener('touchend',    () => keys['ArrowLeft']  = false, {passive:true});
rightBtn.addEventListener('touchstart', () => keys['ArrowRight'] = true,  {passive:true});
rightBtn.addEventListener('touchend',   () => keys['ArrowRight'] = false, {passive:true});
fireBtn.addEventListener('touchstart',  () => keys['Space']      = true,  {passive:true});
fireBtn.addEventListener('touchend',    () => keys['Space']      = false, {passive:true});

// Show mobile controls on touch devices
window.addEventListener('touchstart', () => {
  document.getElementById('mobile-controls').style.display = 'flex';
}, {once: true});

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLAYER_SPEED = 240;  // px/sec
const BULLET_SPEED = 500;
const ALIEN_BULLET_SPEED = 200;
const ALIEN_COLS = 11;
const ALIEN_ROWS = 5;
const ALIEN_W = 36;
const ALIEN_H = 28;
const ALIEN_GAP_X = 16;
const ALIEN_GAP_Y = 18;
const ALIEN_DROP = 18;
const PLAYER_W = 40;
const PLAYER_H = 24;
const SHIELD_W = 60;
const SHIELD_H = 36;
const UFO_SPEED = 120;

// ‚îÄ‚îÄ OBJECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let player, bullets, alienBullets, aliens, shields, ufo;
let alienDir, alienSpeed, alienMoveTimer, alienMoveInterval;
let ufoTimer, ufoActive;
let flashTimer = 0;
let deathTimer = 0;
let winTimer = 0;
let fireHeld = false;
let fireCooldown = 0;

function initGame() {
  score = 0;
  lives = 3;
  level = 1;
  initLevel();
}

function initLevel() {
  player = { x: W/2 - PLAYER_W/2, y: H - 60, w: PLAYER_W, h: PLAYER_H, dead: false };
  bullets = [];
  alienBullets = [];
  alienDir = 1;
  alienSpeed = 30 + level * 8;
  alienMoveInterval = Math.max(0.08, 0.55 - level * 0.06);
  alienMoveTimer = 0;
  ufoTimer = 0;
  ufoActive = false;
  ufo = null;
  flashTimer = 0;
  deathTimer = 0;
  winTimer = 0;
  fireCooldown = 0;

  // Build alien grid
  aliens = [];
  const startX = (W - (ALIEN_COLS * (ALIEN_W + ALIEN_GAP_X) - ALIEN_GAP_X)) / 2;
  const startY = 80;
  for (let r = 0; r < ALIEN_ROWS; r++) {
    for (let c = 0; c < ALIEN_COLS; c++) {
      aliens.push({
        x: startX + c * (ALIEN_W + ALIEN_GAP_X),
        y: startY + r * (ALIEN_H + ALIEN_GAP_Y),
        w: ALIEN_W, h: ALIEN_H,
        row: r, col: c,
        alive: true,
        frame: 0,
        flashTimer: 0
      });
    }
  }

  // Shields
  shields = [];
  const shieldCount = 4;
  const shieldSpacing = W / (shieldCount + 1);
  for (let i = 0; i < shieldCount; i++) {
    shields.push({
      x: shieldSpacing * (i + 1) - SHIELD_W / 2,
      y: H - 130,
      w: SHIELD_W, h: SHIELD_H,
      health: 12,  // pixel damage
      pixels: buildShieldPixels()
    });
  }
}

function buildShieldPixels() {
  // 12√ó8 pixel grid, true = intact
  const grid = [];
  for (let r = 0; r < 8; r++) {
    grid[r] = [];
    for (let c = 0; c < 12; c++) {
      // cut out bottom-middle notch (arch shape)
      const notch = r >= 5 && c >= 4 && c <= 7;
      grid[r][c] = !notch;
    }
  }
  return grid;
}

// ‚îÄ‚îÄ DRAWING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPixelChar(x, y, size, color, shape) {
  ctx.fillStyle = color;
  shape.forEach(([px, py]) => {
    ctx.fillRect(x + px * size, y + py * size, size, size);
  });
}

// Alien shapes (pixel art, 8√ó6 grid)
const ALIEN_SHAPES = {
  // Row 0-1: classic crab (top row, 30pts)
  top: [
    [2,0],[3,0],[4,0],[5,0],
    [1,1],[2,1],[3,1],[4,1],[5,1],[6,1],
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
    [0,3],[2,3],[3,3],[4,3],[5,3],[7,3],
    [0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],
    [1,5],[3,5],[4,5],[6,5],
  ],
  top2: [
    [2,0],[3,0],[4,0],[5,0],
    [1,1],[2,1],[3,1],[4,1],[5,1],[6,1],
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
    [0,3],[2,3],[3,3],[4,3],[5,3],[7,3],
    [0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],
    [0,5],[2,5],[5,5],[7,5],
  ],
  // Row 2-3: squid
  mid: [
    [3,0],[4,0],
    [2,1],[3,1],[4,1],[5,1],
    [1,2],[2,2],[3,2],[4,2],[5,2],[6,2],
    [0,3],[1,3],[3,3],[4,3],[6,3],[7,3],
    [0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],
    [0,5],[2,5],[3,5],[4,5],[5,5],[7,5],
  ],
  mid2: [
    [3,0],[4,0],
    [2,1],[3,1],[4,1],[5,1],
    [1,2],[2,2],[3,2],[4,2],[5,2],[6,2],
    [0,3],[1,3],[3,3],[4,3],[6,3],[7,3],
    [0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],
    [1,5],[3,5],[4,5],[6,5],
  ],
  // Row 4: octopus (bottom, 10pts)
  bot: [
    [2,0],[3,0],[4,0],[5,0],
    [1,1],[2,1],[3,1],[4,1],[5,1],[6,1],
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
    [0,3],[1,3],[3,3],[4,3],[6,3],[7,3],
    [1,4],[2,4],[3,4],[4,4],[5,4],[6,4],
    [0,5],[2,5],[3,5],[4,5],[5,5],[7,5],
  ],
  bot2: [
    [2,0],[3,0],[4,0],[5,0],
    [1,1],[2,1],[3,1],[4,1],[5,1],[6,1],
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
    [0,3],[1,3],[3,3],[4,3],[6,3],[7,3],
    [1,4],[2,4],[3,4],[4,4],[5,4],[6,4],
    [0,5],[3,5],[4,5],[7,5],
  ],
};

const ALIEN_COLORS = ['#0ff','#0ff','#0f0','#0f0','#f80'];

function getAlienShape(row, frame) {
  if (row <= 1) return frame === 0 ? ALIEN_SHAPES.top  : ALIEN_SHAPES.top2;
  if (row <= 3) return frame === 0 ? ALIEN_SHAPES.mid  : ALIEN_SHAPES.mid2;
  return          frame === 0 ? ALIEN_SHAPES.bot  : ALIEN_SHAPES.bot2;
}

// Player ship shape
const PLAYER_SHAPE = [
  [4,0],
  [3,1],[4,1],[5,1],
  [1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
  [0,3],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3],
  [0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],[8,4],
];

// UFO shape
const UFO_SHAPE = [
  [3,0],[4,0],[5,0],[6,0],
  [2,1],[3,1],[4,1],[5,1],[6,1],[7,1],
  [1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[8,2],
  [0,3],[2,3],[4,3],[6,3],[8,3],
];

function drawAlien(a, px) {
  const sz = 4;
  const color = a.flashTimer > 0 ? '#fff' : ALIEN_COLORS[a.row];
  drawPixelChar(a.x, a.y, sz, color, getAlienShape(a.row, a.frame));
}

function drawPlayer() {
  if (player.dead) return;
  const sz = 4;
  const color = flashTimer > 0 ? '#f00' : '#0f0';
  drawPixelChar(player.x, player.y, sz, color, PLAYER_SHAPE);
}

function drawBullet(b) {
  ctx.fillStyle = '#ff0';
  ctx.fillRect(b.x - 2, b.y - 8, 4, 10);
}

function drawAlienBullet(b) {
  ctx.fillStyle = '#f44';
  ctx.fillRect(b.x - 2, b.y, 4, 10);
}

function drawShield(s) {
  const pw = s.w / 12;
  const ph = s.h / 8;
  ctx.fillStyle = '#0a0';
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 12; c++) {
      if (s.pixels[r][c]) {
        ctx.fillRect(s.x + c * pw, s.y + r * ph, pw - 1, ph - 1);
      }
    }
  }
}

function drawUFO() {
  if (!ufoActive || !ufo) return;
  ctx.fillStyle = '#f0f';
  drawPixelChar(ufo.x, ufo.y, 3, '#f0f', UFO_SHAPE);
  // score hint above
  ctx.fillStyle = '#f0f';
  ctx.font = '0.3rem Press Start 2P, monospace';
  ctx.textAlign = 'center';
  ctx.fillText('???', ufo.x + 13, ufo.y - 4);
}

function drawStars() {
  ctx.fillStyle = 'rgba(255,255,255,0.7)';
  // deterministic star field
  for (let i = 0; i < 60; i++) {
    const sx = (i * 137 + 47) % W;
    const sy = (i * 97  + 23) % H;
    const sz = (i % 3 === 0) ? 2 : 1;
    ctx.fillRect(sx, sy, sz, sz);
  }
}

function drawGround() {
  ctx.fillStyle = '#0f0';
  ctx.fillRect(0, H - 20, W, 2);
}

function drawExplosion(x, y, size) {
  const pts = [[0,-1],[1,-1],[0,0],[-1,0],[1,0],[-1,1],[0,1],[1,1],[-1,-1]];
  ctx.fillStyle = '#ff0';
  pts.forEach(([px,py]) => ctx.fillRect(x + px*size, y + py*size, size, size));
}

// ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(dt) {
  if (state !== 'playing') return;

  fireCooldown -= dt;
  flashTimer = Math.max(0, flashTimer - dt);

  // Player movement
  if (!player.dead) {
    if (keys['ArrowLeft'])  player.x = Math.max(0, player.x - PLAYER_SPEED * dt);
    if (keys['ArrowRight']) player.x = Math.min(W - PLAYER_W, player.x + PLAYER_SPEED * dt);

    // Fire
    if (keys['Space'] && !fireHeld && fireCooldown <= 0 && bullets.length < 3) {
      bullets.push({ x: player.x + PLAYER_W/2, y: player.y });
      fireCooldown = 0.3;
      fireHeld = true;
    }
    if (!keys['Space']) fireHeld = false;
  }

  // Bullets
  bullets = bullets.filter(b => {
    b.y -= BULLET_SPEED * dt;
    return b.y > 0;
  });

  // Alien bullets
  alienBullets = alienBullets.filter(b => {
    b.y += ALIEN_BULLET_SPEED * dt;
    return b.y < H;
  });

  // Alien movement
  alienMoveTimer += dt;
  if (alienMoveTimer >= alienMoveInterval) {
    alienMoveTimer = 0;
    moveAliens();
  }

  // Alien flash timers
  aliens.forEach(a => { if (a.flashTimer > 0) a.flashTimer -= dt; });

  // Alien shooting
  const aliveAliens = aliens.filter(a => a.alive);
  if (aliveAliens.length > 0 && alienBullets.length < 3 && Math.random() < 0.02) {
    // pick a random alien from the bottom of each column
    const bottomAliens = [];
    for (let c = 0; c < ALIEN_COLS; c++) {
      const col = aliveAliens.filter(a => a.col === c);
      if (col.length > 0) {
        col.sort((a,b) => b.row - a.row);
        bottomAliens.push(col[0]);
      }
    }
    if (bottomAliens.length > 0) {
      const shooter = bottomAliens[Math.floor(Math.random() * bottomAliens.length)];
      alienBullets.push({ x: shooter.x + shooter.w/2, y: shooter.y + shooter.h });
    }
  }

  // UFO
  ufoTimer += dt;
  if (ufoTimer > 15 && !ufoActive) {
    ufoActive = true;
    ufo = { x: -40, y: 30, dir: 1 };
    ufoTimer = 0;
  }
  if (ufoActive && ufo) {
    ufo.x += UFO_SPEED * dt;
    if (ufo.x > W + 40) { ufoActive = false; ufo = null; }
  }

  // Bullet vs alien collision
  bullets.forEach((b, bi) => {
    aliens.forEach((a, ai) => {
      if (!a.alive) return;
      if (b.x > a.x && b.x < a.x + a.w && b.y > a.y && b.y < a.y + a.h) {
        a.alive = false;
        bullets.splice(bi, 1);
        const pts = a.row <= 1 ? 30 : a.row <= 3 ? 20 : 10;
        score += pts;
        updateHUD();
        // Speed up remaining aliens
        alienMoveInterval = Math.max(0.04, alienMoveInterval - 0.01);
      }
    });

    // Bullet vs UFO
    if (ufoActive && ufo) {
      if (b.x > ufo.x && b.x < ufo.x + 27 && b.y > ufo.y && b.y < ufo.y + 12) {
        ufoActive = false; ufo = null;
        const ufoScore = [50,100,150,300][Math.floor(Math.random()*4)];
        score += ufoScore;
        updateHUD();
        bullets.splice(bi, 1);
      }
    }

    // Bullet vs shield
    shields.forEach(s => damageTile(s, b.x, b.y, () => bullets.splice(bi, 1)));
  });

  // Alien bullet vs player
  alienBullets.forEach((b, bi) => {
    if (!player.dead &&
        b.x > player.x && b.x < player.x + PLAYER_W &&
        b.y > player.y && b.y < player.y + PLAYER_H) {
      alienBullets.splice(bi, 1);
      hitPlayer();
    }

    // Alien bullet vs shield
    shields.forEach(s => damageTile(s, b.x, b.y, () => alienBullets.splice(bi, 1)));
  });

  // Aliens reach ground
  if (aliveAliens.some(a => a.y + a.h >= H - 20)) {
    gameOver();
    return;
  }

  // Win check
  if (aliveAliens.length === 0) {
    winTimer += dt;
    if (winTimer > 1.5) {
      level++;
      initLevel();
    }
  }

  // Death animation
  if (player.dead) {
    deathTimer -= dt;
    if (deathTimer <= 0) {
      if (lives <= 0) {
        gameOver();
      } else {
        player.dead = false;
        player.x = W/2 - PLAYER_W/2;
        player.y = H - 60;
        flashTimer = 1.5; // brief invincibility flash
      }
    }
  }
}

function moveAliens() {
  const aliveAliens = aliens.filter(a => a.alive);
  if (aliveAliens.length === 0) return;

  // Toggle animation frame
  aliens.forEach(a => a.frame = a.frame === 0 ? 1 : 0);

  // Check if any alien hits wall
  const rightmost = Math.max(...aliveAliens.map(a => a.x + a.w));
  const leftmost  = Math.min(...aliveAliens.map(a => a.x));

  if ((alienDir === 1 && rightmost >= W - 4) ||
      (alienDir === -1 && leftmost <= 4)) {
    // drop and reverse
    aliens.forEach(a => a.y += ALIEN_DROP);
    alienDir *= -1;
  } else {
    aliens.forEach(a => a.x += alienDir * alienSpeed);
  }
}

function damageTile(shield, bx, by, onHit) {
  const pw = shield.w / 12;
  const ph = shield.h / 8;
  if (bx < shield.x || bx > shield.x + shield.w ||
      by < shield.y || by > shield.y + shield.h) return;
  const col = Math.floor((bx - shield.x) / pw);
  const row = Math.floor((by - shield.y) / ph);
  if (row >= 0 && row < 8 && col >= 0 && col < 12 && shield.pixels[row]?.[col]) {
    shield.pixels[row][col] = false;
    // damage surrounding pixels
    [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => {
      const nr = row+dr, nc = col+dc;
      if (nr >= 0 && nr < 8 && nc >= 0 && nc < 12 && Math.random() < 0.5)
        shield.pixels[nr][nc] = false;
    });
    onHit();
  }
}

function hitPlayer() {
  if (player.dead || flashTimer > 0) return;
  lives--;
  updateHUD();
  player.dead = true;
  deathTimer = 1.2;
}

function gameOver() {
  state = 'gameover';
  if (score > hiScore) hiScore = score;
  updateHUD();
  showOverlay('GAME OVER', `SCORE: ${score}<br><br>HI-SCORE: ${hiScore}`, 'PLAY AGAIN');
}

function showOverlay(title, body, btnText) {
  const ov = document.getElementById('overlay');
  ov.style.display = 'flex';
  ov.innerHTML = `
    <h1>${title}</h1>
    <p style="color:#ff0; font-size:0.45rem; line-height:2.5;">${body}</p>
    <button id="start-btn" style="
      background:transparent;border:2px solid #0f0;color:#0f0;
      font-family:'Press Start 2P',monospace;font-size:0.5rem;
      padding:12px 24px;cursor:pointer;">
      ${btnText}
    </button>`;
  document.getElementById('start-btn').onclick = startGame;
}

function updateHUD() {
  document.getElementById('score-display').textContent = score;
  document.getElementById('hi-display').textContent = hiScore;
  document.getElementById('lives-display').textContent = '‚ô•'.repeat(Math.max(0, lives));
}

// ‚îÄ‚îÄ DRAW LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw() {
  ctx.clearRect(0, 0, W, H);
  drawStars();
  drawGround();
  shields.forEach(drawShield);
  aliens.filter(a => a.alive).forEach(drawAlien);
  bullets.forEach(drawBullet);
  alienBullets.forEach(drawAlienBullet);
  drawPlayer();
  drawUFO();

  // Level banner
  if (level > 1 && winTimer > 0 && winTimer < 1.5) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(0, H/2 - 30, W, 60);
    ctx.fillStyle = '#0f0';
    ctx.font = '0.6rem Press Start 2P, monospace';
    ctx.textAlign = 'center';
    ctx.fillText(`LEVEL ${level}`, W/2, H/2 + 8);
  }

  // Death flash
  if (player.dead && Math.floor(deathTimer * 8) % 2 === 0) {
    ctx.fillStyle = 'rgba(255,0,0,0.15)';
    ctx.fillRect(0, 0, W, H);
  }
}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(ts) {
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;
  update(dt);
  draw();
  animId = requestAnimationFrame(loop);
}

function startGame() {
  document.getElementById('overlay').style.display = 'none';
  cancelAnimationFrame(animId);
  initGame();
  updateHUD();
  state = 'playing';
  lastTime = performance.now();
  animId = requestAnimationFrame(loop);
}

// Init overlay start button
document.getElementById('start-btn').onclick = startGame;
</script>
</body>
</html>
